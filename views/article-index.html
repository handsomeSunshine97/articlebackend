<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  {{ include './common/linkcss.html' }}
  <link rel="stylesheet" href="/public/css/lightbox.css">
</head>

<body class="layui-layout-body">
  <div class="layui-layout layui-layout-admin">

    <!-- 引入左边侧边栏 -->
    {{ include './common/header.html' }}

    <!-- 引入左边侧边栏 -->
    {{ include './common/side.html' }}


    <div class="layui-body">

      <!-- 内容主体区域 -->

      <div style="padding: 15px;">
        <h2>文章管理</h2>
        <div>
            <button type="button" id="add"  class="layui-btn">
                <i class="layui-icon">&#xe608;</i> 添加文章
            </button>
        </div>
       
        <table class="layui-hide" id="test" lay-filter="test"></table>
      </div>

      <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="show">查看内容</a>
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
      </script>


    </div>

    <!-- 引入左边侧边栏 -->
    {{ include './common/footer.html' }}

  </div>
  {{ include './common/scriptjs.html' }}
  <script src="/public/js/lightbox-plus-jquery.min.js"></script>
  <script>
    //JavaScript代码区域
    layui.use(['element', 'table'], function () {
      var element = layui.element;
      var table = layui.table;

      let tableUI = table.render({
        elem: '#test',
        url: '/allarticle',
        cellMinWidth: 100,
        toolbar: '#toolbarDemo' //开启头部工具栏，并为其绑定左侧模板
          ,
        defaultToolbar: ['filter', 'exports', 'print', { //自定义头部工具栏右侧图标。如无需自定义，去除该参数即可
          title: '提示',
          layEvent: 'LAYTABLE_TIPS',
          icon: 'layui-icon-tips'
        }],
        limit: 5,
        limits: [5, 10, 15, 20],
        request: {
          pageName: 'page' //页码的参数名称，默认：page
            ,
          limitName: 'limit' //每页数据量的参数名，默认：limit

        },
        where: {
          a: 2,
          b: 3
        },
        title: '文章数据',
        cols: [
          [{
            type: 'checkbox',
            fixed: 'left'
          }, {
            field: 'art_id',
            title: 'ID',
            width: 80,
            fixed: 'left',
            unresize: true,
            hide:true
          }, {
            field: 'title',
            title: '标题',
            width: 120,
            edit: 'text'
          }, {
            field: 'content',
            title: '内容',
            width: 120
          }, {
            field: 'name',
            title: '所属分类',
            width: 150
          }, {
            field: 'author',
            title: '作者',
            width: 80,
            edit: 'text',
            sort: true
          }, {
            field: 'cover',
            title: '图片',
            width: 100,
            templet({cover}){
              
              let str = ` <a class="example-image-link" href="${cover}" data-lightbox="example-1" data-title="我帅木">
                          <img class="example-image" src="${cover}" alt="image-1" />
                      </a>`
              return str;
            }
          }, {
            field: 'status',
            title: '状态',
            width: 100,
            templet: (item) => {
              // 映射关系 或 new Map也行
              let statusMap = {
                "0": "<span class='layui-badge layui-bg-orange'>未发布</span>",
                "1": "<span class='layui-badge layui-bg-green'>已发布</span>",
                "2": "审核中"
              }
              return statusMap[item.status]
            }
          }, {
            field: 'publish_date',
            title: '发布时间',
            sort: true,
            templet(item) {
              let {
                publish_date
              } = item;
              return util.date_format(publish_date)
            }
          }, {
            fixed: 'right',
            title: '操作',
            // toolbar: '#barDemo',
            templet({status}){
              let str = `<a class="layui-btn layui-btn-xs" style='background:#01AAED;' lay-event="show">查看内容</a>`;
                switch(status){
                  case 0: // 询问是否审核通过
                    str += `<a class="layui-btn layui-btn-xs" style='background:#FFB800;' lay-event="show">待审核</a>`
                    break;
                  case 1:
                    str += `<a class="layui-btn layui-btn-xs" style='background:green;' lay-event="show">审核成功</a>`
                    break;
                  default:
                    break;
                }
              str += `<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
                      <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>`;
              return str;
            }
          }]
        ],
        page: true,
        parseData: function (res) {
            // 可以对返回的数据格式进行调整，修改符合table所需要的的格式
            // console.log(res);// 后台接口原数据
            return res;
          }
          // 如果后台接口返回的参数table参数不一致，可以在这里重新定义
          ,
        response: {},
        text: {
          none: '暂无相关数据' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
        }
      });


      //监听删除、编辑事件
      table.on('tool(test)', function (obj) {
        let {
          data,
          event
        } = obj;
        let {art_id} = data;
        switch (event) {
          case "del":
            del(art_id)
            break;
          case "edit":
            edit(art_id)
            break;

        }



      });

      // 删除文章
      function del(art_id) {
            layer.confirm('确认删除', {
                btn: ['是的', '取消?'] //按钮
            }, function () {
                 // 发送ajax请求
                $.ajax({
                    type:'post',
                    url:"/delArticle",
                    data:{art_id},
                    success({errcode,message}){ // 解构形参对象的参数
                        // let {errcode,message} = res;
                        layer.closeAll();
                        if(errcode == 0){
                            tableUI.reload(); // 只是重载表格（局部刷新）
                            // location.reload() 刷新当前网页
                            layer.msg(message)
                        }
                    }
                })
            });
      }

      // 跳转到文章编辑页面
      function edit(art_id){
        // 需要把id携带过去
        location.href = `/artedit?art_id=${art_id}`
      }

      // 跳转到文章添加页面
      $("#add").on('click',()=>{
        location.href = '/addart'
      })

    });
  </script>
</body>

</html>